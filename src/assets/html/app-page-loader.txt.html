<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Loading...</title>
  <style>
    :root {
      --bg-color: #F8F8F8;
      --text-color: #333;
      --accent-color: #7A3AD3;
      --accent-darker-color: #8242D9;
      --icon-bg-color: #E9E9E9;
      --progress-bar-bg: #E9E9E9;
      /* Pixel art colors */
      --pixel-ostrich-body: var(--accent-color);
      --pixel-ostrich-beak: #FFA500; /* Orange */
      --pixel-ostrich-leg: #8B4513; /* SaddleBrown */
      --pixel-ostrich-eye: #000000; /* Black */
      --pixel-ostrich-accent: var(--accent-darker-color);
      --pulse-bg-1: #f0f0f0;
      --pulse-bg-2: #999999;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1E1E1E;
        --text-color: #EAEAEA;
        --accent-color: #B589F9;
        --accent-darker-color: #A069F6;
        --icon-bg-color: #3A3A3A;
        --progress-bar-bg: #3A3A3A;
        --pixel-ostrich-beak: #FFC966;
        --pixel-ostrich-leg: #A0522D;
        --pixel-ostrich-eye: #FFFFFF;
        --pulse-bg-1: #000000;
        --pulse-bg-2: #1E1E1E;
      }
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      visibility: hidden;
    }

    #pulse-background {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100dvw;
      height: 100dvh;
      z-index: 1;
    }

    #pulse-background.pulsing {
      display: block;
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { background-color: var(--pulse-bg-1); }
      50% { background-color: var(--pulse-bg-2); }
      100% { background-color: var(--pulse-bg-1); }
    }

    .loader-container {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .ostrich-wrapper {
      width: 150px;
      height: 180px;
      margin-bottom: 20px;
      animation: wait-bob 2s ease-in-out infinite;
    }

    #pixel-ostrich {
        width: 10px;
        height: 10px;
        background: var(--pixel-ostrich-body);
        margin: 80px auto;
        box-shadow:
            /* head */
            10px -20px 0 0 var(--pixel-ostrich-body),
            20px -20px 0 0 var(--pixel-ostrich-body),
            0px -10px 0 0 var(--pixel-ostrich-body),
            10px -10px 0 0 var(--pixel-ostrich-body),
            20px -10px 0 0 var(--pixel-ostrich-body),
            30px -10px 0 0 var(--pixel-ostrich-body),
            /* eye */
            20px -10px 0 0 var(--pixel-ostrich-eye),
            /* beak */
            30px -10px 0 0 var(--pixel-ostrich-beak),
            40px -10px 0 0 var(--pixel-ostrich-beak),
            /* neck */
            0 10px 0 0 var(--pixel-ostrich-accent),
            0 20px 0 0 var(--pixel-ostrich-accent),
            0 30px 0 0 var(--pixel-ostrich-accent),
            /* body */
            -10px 40px 0 0 var(--pixel-ostrich-body),
            0px 40px 0 0 var(--pixel-ostrich-body),
            10px 40px 0 0 var(--pixel-ostrich-body),
            20px 40px 0 0 var(--pixel-ostrich-body),
            -20px 50px 0 0 var(--pixel-ostrich-body),
            -10px 50px 0 0 var(--pixel-ostrich-body),
            0px 50px 0 0 var(--pixel-ostrich-body),
            10px 50px 0 0 var(--pixel-ostrich-body),
            20px 50px 0 0 var(--pixel-ostrich-body),
            30px 50px 0 0 var(--pixel-ostrich-body),
            -10px 60px 0 0 var(--pixel-ostrich-body),
            0px 60px 0 0 var(--pixel-ostrich-body),
            10px 60px 0 0 var(--pixel-ostrich-body),
            20px 60px 0 0 var(--pixel-ostrich-body),
            /* legs */
            -10px 70px 0 0 var(--pixel-ostrich-leg),
            10px 70px 0 0 var(--pixel-ostrich-leg),
            -10px 80px 0 0 var(--pixel-ostrich-leg),
            10px 80px 0 0 var(--pixel-ostrich-leg);
        position: relative;
    }

    .progress-bar-container {
      width: 220px;
      height: 16px;
      background-color: var(--progress-bar-bg);
      border-radius: 8px;
      overflow: hidden;
    }

    #progress-bar {
      width: 0%;
      height: 100%;
      background-color: var(--accent-color);
      border-radius: 8px;
      transition: width 0.4s ease;
    }

    #progress-text {
      margin-top: 10px;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 25px;
    }

    #icon-display {
      width: 80px;
      height: 80px;
      transition: transform 0.5s ease;
      transform: scale(0);
      position: relative;
    }

    #icon-clipper {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        border-radius: 25%;
        background-color: var(--icon-bg-color);
        overflow: hidden;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.8s ease-in-out;
    }

    #icon-clipper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #default-icon {
      width: 100%;
      height: 100%;
    }

    #icon-display.ready {
        transform: scale(1);
    }

    /* === OSTRICH ANIMATIONS === */
    @keyframes wait-bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .ostrich-wrapper.celebrating {
      animation: celebrate-dance 1.2s ease-in-out forwards;
    }

    @keyframes celebrate-dance {
      0% { transform: scale(1) rotate(0deg); }
      20% { transform: scale(1.1) rotate(-8deg) translateY(-15px); }
      40% { transform: scale(1.1) rotate(8deg) translateY(-15px); }
      60% { transform: scale(1.1) rotate(-8deg) translateY(-15px); }
      80% { transform: scale(1.1) rotate(8deg) translateY(-15px); }
      100% { transform: scale(1) rotate(0deg) translateY(0); }
    }
  </style>
</head>
<body>
  <div id="pulse-background"></div>
  <div class="loader-container">
    <div class="ostrich-wrapper" id="ostrich-wrapper">
      <div id="pixel-ostrich"></div>
    </div>

    <div class="progress-bar-container">
      <div id="progress-bar"></div>
    </div>
    <div id="progress-text">Loading...</div>

    <div id="icon-display">
        <div id="icon-clipper">
            <svg id="default-icon" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                <g id="shape-rotator">
                    <circle cx="11" cy="11" r="7" fill="#FF6B6B"/>
                    <polygon points="29,4.94 22,17.06 36,17.06" fill="#4ECDC4"/>
                    <rect x="4" y="22" width="14" height="14" rx="2" fill="#45B7D1"/>
                    <path d="M28 22 H 30 V 28 H 36 V 30 H 30 V 36 H 28 V 30 H 22 V 28 H 28 Z" fill="#F9D423"/>
                </g>
            </svg>
        </div>
    </div>
  </div>

  <script>
    document.body.style.visibility = 'hidden';

    if (window.parent !== window.top) {
      document.querySelector('.loader-container').style.display = 'none';
      const pulseBg = document.getElementById('pulse-background');
      pulseBg.classList.add('pulsing');
      document.body.style.visibility = 'visible';
      document.addEventListener('DOMContentLoaded', () => {
        napp.addEventListener('progress', () => {
          maybeReload(napp.progress)
        })
      })
      function maybeReload (progress) {
        if (progress < 100) return
        window.location.reload()
      }
    } else {
      document.body.style.visibility = 'visible';
      document.addEventListener('DOMContentLoaded', () => {
        const napp = window.napp || new EventTarget()

        const iconDisplay = document.getElementById('icon-display')
        const iconClipper = document.getElementById('icon-clipper')
        const ostrichWrapper = document.getElementById('ostrich-wrapper')
        const progressBar = document.getElementById('progress-bar')
        const progressText = document.getElementById('progress-text')

        let isDone = false
        let animationInterval
        let currentRotation = 0

        function startDefaultIconAnimation () {
          animationInterval = setInterval(() => {
            currentRotation += 90
            iconClipper.style.transform = `rotate(${currentRotation}deg)`
          }, 4000)
        }

        function showIcon (iconUrl) {
          iconDisplay.classList.add('ready')
          if (iconUrl && typeof iconUrl === 'string') {
            clearInterval(animationInterval)
            iconClipper.style.transform = 'rotate(0deg)' // Reset rotation
            iconClipper.innerHTML = ''
            const img = document.createElement('img')
            img.alt = 'App Icon'
            img.style.opacity = '0'
            img.style.transition = 'opacity .5s'
            img.style.willChange = 'opacity'

            let isBlob = false
            img.addEventListener('load', () => {
              // Double rAF ensures at least one paint with opacity 0 before transitioning
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  img.style.opacity = '1'
                })
              })
            }, { once: true })

            img.addEventListener('transitionend', e => {
              if (e.propertyName === 'opacity' && isBlob) {
                try { URL.revokeObjectURL(img.src) } catch (e) { /* ignore */ }
              }
            }, { once: true })

            // Append to DOM first to ensure opacity 0 can be painted
            iconClipper.appendChild(img)

            // Set src after element is in DOM and styles are committed
            queueMicrotask(() => {
              isBlob = iconUrl.startsWith('blob:')
              img.src = iconUrl

              // Handle already-cached images (complete before load event)
              if (img.complete) {
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    img.style.opacity = '1'
                  })
                })
              }
            })
          }
        }

        function updateProgress (progress) {
          if (isDone || typeof progress !== 'number' || progress < 0) return

          const currentProgress = Math.min(progress, 100)
          progressBar.style.width = `${currentProgress}%`
          progressText.textContent = `Loading... ${currentProgress}%`

          if (currentProgress >= 100) {
            isDone = true
            progressText.textContent = 'Done!'
            clearInterval(animationInterval)
            setTimeout(() => {
              ostrichWrapper.classList.add('celebrating')
              setTimeout(() => {
                window.location.reload()
              }, 1200)
            }, 300)
          }
        }

        // Show default icon and start its animation
        showIcon()
        startDefaultIconAnimation()

        // Event Listeners
        napp.addEventListener('iconready', () => {
          showIcon(napp.icon)
        })

        napp.addEventListener('progress', () => {
          updateProgress(napp.progress)
        })

        // Initial state check
        if (napp.icon) {
          showIcon(napp.icon)
        }
        if (napp.progress) {
          updateProgress(napp.progress)
        }

        // --- For testing purposes ---
        if (!window.napp) {
          console.log('Mocking window.napp for testing.')
          window.napp = napp
          let mockProgress = 0

          setTimeout(() => {
            napp.icon = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjAiIHkyPSIxMjgiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiMzMjc0Y2UiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMxYzNkNjkiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgcng9IjI0IiBmaWxsPSJ1cmwoI2cpIi8+PHBhdGggZD0iTTY0IDM0Yy0xNiAwLTI5IDEzLTI5IDI5czEzIDI5IDI5IDI5IDI5LTEzIDI5LTI5LTEzLTI5LTI5LTI5em0wIDQ4Yy0xMC41IDAtMTktOC41LTE5LTE5czguNS0xOSAxOS0xOSAxOSA4LjUgMTkgMTktOC41IDE5LTE5IDE5em0wLTI5bC0xNCAyMWg4bC0yIDloMTZsLTItOWg4eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=='
            napp.dispatchEvent(new CustomEvent('iconready'))
          }, 5000)

          const interval = setInterval(() => {
            mockProgress += Math.floor(Math.random() * 10) + 5
            napp.progress = mockProgress
            napp.dispatchEvent(new CustomEvent('progress'))
            if (mockProgress >= 100) {
              clearInterval(interval)
            }
          }, 800)
        }
      })
    }
  </script>
</body>
</html>
