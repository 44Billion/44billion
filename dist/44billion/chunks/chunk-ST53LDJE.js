import{b as F,c as K,d as _,f as J,h as Z,i as W,j as R,k as x,l as U,n as q}from"./chunk-DF4IVW5S.js";import{g as N,l as M,n as T}from"./chunk-YCNW34TK.js";import{a as D,b as P,e as I}from"./chunk-KN6GOQRR.js";import{h as w,k as A,m as O,n as E,o as k,p as S,v as H,w as C}from"./chunk-K2UKPH6Q.js";var z=new Map,v=class{constructor(t,r,o){if(!o||o.length===0)throw new Error("Write relays cannot be empty");this.appId=t,this.fileRootHash=r,this.writeRelays=o,this.sharedKey=`${t}:${r}`}static async getBundleEvents(t,{_getUserRelays:r=R,_getEventsByStrategy:o=W}={}){if(!t||t.length===0)return{};let s={},a={};for(let l of t){let d=M(l);a[l]=d,s[d.pubkey]||(s[d.pubkey]=[]),s[d.pubkey].push(d)}let e=Object.keys(s),c=await r(e),n={kinds:[],authors:e,"#d":[],until:Math.floor(Date.now()/1e3)};for(let l of t){let d=a[l];n.kinds.includes(d.kind)||n.kinds.push(d.kind),n["#d"].includes(d.dTag)||n["#d"].push(d.dTag)}let i=await o(n,{code:"WRITE_RELAYS",maxRelaysPerUser:7,userRelays:c}),u={};for(let l of t){let d=a[l],h=i.find(p=>p.kind===d.kind&&p.pubkey===d.pubkey&&p.tags.find(m=>m[0]==="d")?.[1]===d.dTag);h&&(u[l]={event:h,writeRelays:Array.from(c[d.pubkey]?.write||[])})}return u}async*run({_nostrRelays:t=Z,_countFileChunksFromDb:r=F,_getFileChunksFromDb:o=_,_saveFileChunksToDB:s=J}={}){let a={_nostrRelays:t,_countFileChunksFromDb:r,_getFileChunksFromDb:o,_saveFileChunksToDB:s},e=z.get(this.sharedKey);e||(e={total:null,downloaded:new Set,fetching:new Set,missingByRelay:new Map,error:null,instances:0,initPromise:null},e.initPromise=this._initState(e,a),z.set(this.sharedKey,e)),e.instances++;try{await e.initPromise;let c=()=>({progress:e.total?Math.floor(e.downloaded.size/e.total*100):0,error:e.error});for(yield c();;){if(e.error){yield c();return}if(e.total!==null&&e.downloaded.size>=e.total){yield{progress:100,error:null};return}let n=[];if(e.total===null)!e.downloaded.has(0)&&!e.fetching.has(0)&&n.push(0);else for(let p=0;p<e.total;p++)!e.downloaded.has(p)&&!e.fetching.has(p)&&n.push(p);if(n.length===0){if(e.total===null&&e.fetching.size>0){await new Promise(p=>setTimeout(p,100));continue}if(e.total!==null&&e.downloaded.size<e.total&&e.fetching.size>0){await new Promise(p=>setTimeout(p,100));continue}if(e.total===null){e.error=new Error("Could not find file metadata (chunk 0)"),yield c();return}e.downloaded.size<e.total}let i=20,u=new Map,l=this.writeRelays.length*i,d=n.slice(0,l);for(let p of d)for(let m=0;m<this.writeRelays.length;m++){let b=(p+m)%this.writeRelays.length,g=this.writeRelays[b];if(e.missingByRelay.get(g)?.has(p))continue;u.has(g)||u.set(g,[]);let y=u.get(g);if(y.length<i){y.push(p),e.fetching.add(p);break}}if(u.size===0){if(e.fetching.size>0){await new Promise(p=>setTimeout(p,100));continue}e.error=new Error("Chunks missing from all relays"),yield c();return}let h=[];for(let[p,m]of u)h.push(this._fetchFromRelay(p,m,e,a));await Promise.all(h),yield c()}}finally{e.instances--,e.instances===0&&z.delete(this.sharedKey)}}async _initState(t,{_countFileChunksFromDb:r,_getFileChunksFromDb:o}){let s=await r(this.appId,this.fileRootHash);s.total&&(t.total=s.total);let a=await o(this.appId,this.fileRootHash,{justKeys:!0});for(let e of a)t.downloaded.add(e[2])}async _fetchFromRelay(t,r,o,{_nostrRelays:s,_saveFileChunksToDB:a}){let{pubkey:e}=M(this.appId),c={kinds:[34600],authors:[e],"#c":r.map(n=>`${this.fileRootHash}:${n}`)};try{let{result:n}=await s.getEvents(c,[t]),i=new Set,u={tags:[["file",this.fileRootHash]]};if(n&&n.length>0){await a(u,n,this.appId);for(let l of n){let d=l.tags.find(h=>h[0]==="c"&&h[1].startsWith(`${this.fileRootHash}:`));if(d){let h=d[1].split(":"),p=parseInt(h[1]);i.add(p),o.downloaded.add(p),o.total===null&&d[2]&&(o.total=parseInt(d[2]))}}}for(let l of r)o.fetching.delete(l),i.has(l)||(o.missingByRelay.has(t)||o.missingByRelay.set(t,new Set),o.missingByRelay.get(t).add(l))}catch(n){console.error(`Error fetching from ${t}`,n);for(let i of r)o.fetching.delete(i)}}};var B=class{static _pendingSearches=new Map;static getInstalledAppIds({_localStorage:t}={}){let r=t||localStorage,o=JSON.parse(r.getItem("session_workspaceKeys")||"[]"),s=new Set;return o.forEach(a=>{let e=JSON.parse(r.getItem(`session_workspaceByKey_${a}_pinnedAppIds`)||"[]"),c=JSON.parse(r.getItem(`session_workspaceByKey_${a}_unpinnedAppIds`)||"[]");e.forEach(n=>s.add(n)),c.forEach(n=>s.add(n))}),Array.from(s)}static searchForUpdates(t,{_AppFileDownloader:r=v,_getBundleFromDb:o=x,_saveBundleToDb:s=U,_setWebStorageItem:a=D,_localStorage:e}={}){let c=t;(!c||c.length===0)&&(c=this.getInstalledAppIds({_localStorage:e}));let n=JSON.stringify(c.slice().sort());if(this._pendingSearches.has(n))return this._pendingSearches.get(n);let i=(async()=>{try{if(c.length===0)return{};let u=await r.getBundleEvents(c),l={};for(let p of c){let m=await o(p),b=u[p];if(b){let g=b.event,y=!1;m?g.created_at>m.created_at&&(y=!0):y=!0,y&&(l[p]=b),m&&await s(m,{...m.meta,hasUpdate:y})}else m&&await s(m,{...m.meta,hasUpdate:!1})}let d=this.getInstalledAppIds({_localStorage:e}),h=0;for(let p of d)(await o(p))?.meta?.hasUpdate&&h++;return a(e||(typeof localStorage<"u"?localStorage:null),"session_unread_appUpdateCount",h),l}finally{this._pendingSearches.delete(n)}})();return this._pendingSearches.set(n,i),i}static isAppOpen(t,{_localStorage:r}={}){let o=r||(typeof localStorage<"u"?localStorage:null);if(!o)return!1;let s=JSON.parse(o.getItem("session_workspaceKeys")||"[]");for(let a of s){let e=JSON.parse(o.getItem(`session_workspaceByKey_${a}_openAppKeys`)||"[]");if(JSON.parse(o.getItem(`session_workspaceByKey_${a}_appById_${t}_appKeys`)||"[]").some(n=>e.includes(n)))return!0}return!1}static async scheduleCleanup(t=null,{_localStorage:r,_getBundleFromDb:o=x,_deleteStaleFileChunksFromDb:s=K,_navigator:a=typeof navigator<"u"?navigator:null,_setTimeout:e=setTimeout,ifAvailable:c=!1}={}){if(a?.locks)return a.locks.request("app-cleanup-job",{ifAvailable:c},async n=>{if(!n)return;let i=t||this.getInstalledAppIds({_localStorage:r}),u=[];for(let l of i)if(this.isAppOpen(l,{_localStorage:r}))u.push(l);else{let d=await o(l);if(d){let h=d.tags.filter(p=>p[0]==="file").map(p=>p[1]);await s(l,h)}}u.length>0&&e(()=>{this.scheduleCleanup(u,{_localStorage:r,_getBundleFromDb:o,_deleteStaleFileChunksFromDb:s,_navigator:a,_setTimeout:e})},5*60*1e3)})}static initCleanupJob({_setTimeout:t=setTimeout,...r}={}){t(()=>this.scheduleCleanup(null,{...r,ifAvailable:!0}),2*60*1e3)}static async scheduleUpdateCheck({_navigator:t=typeof navigator<"u"?navigator:null,_setTimeout:r=setTimeout,ifAvailable:o=!1,interval:s=15*60*1e3,...a}={}){if(!t?.locks)return;if((t.connection||t.mozConnection||t.webkitConnection)?.metered){r(()=>this.scheduleUpdateCheck({_navigator:t,_setTimeout:r,interval:s,...a}),s);return}return t.locks.request("app-update-check-job",{ifAvailable:o},async c=>{if(c){try{await this.searchForUpdates(null,a)}catch(n){console.error("Update check failed",n)}r(()=>{this.scheduleUpdateCheck({_navigator:t,_setTimeout:r,interval:s,...a})},s)}})}static initUpdateCheckJob({_setTimeout:t=setTimeout,...r}={}){t(()=>this.scheduleUpdateCheck({...r,ifAvailable:!0}),1*60*1e3)}static async*updateApp(t,{_AppFileDownloader:r=v,_deleteStaleFileChunksFromDb:o=K,_saveBundleToDb:s=U,_getBundleFromDb:a=x,_addressObjToAppId:e=T,_getUserRelays:c=R,_localStorage:n,writeRelays:i}={}){let u=t.tags.find(g=>g[0]==="d")?.[1],l=e({kind:t.kind,pubkey:t.pubkey,dTag:u});if(!i){let g=await c([t.pubkey]);i=Array.from(g[t.pubkey].write)}let d=t.tags.filter(g=>g[0]==="file").map(g=>({rootHash:g[1],filename:g[2]})),h=d.length;for(let g=0;g<h;g++){let y=d[g],X=new r(l,y.rootHash,i);try{for await(let $ of X.run()){if($.error){yield{appProgress:0,fileProgress:0,error:$.error};return}yield{appProgress:Math.floor((g*100+$.progress)/h),fileProgress:$.progress,currentFile:y.filename,error:null}}}catch($){yield{appProgress:0,fileProgress:0,error:$};return}}let p=d.map(g=>g.rootHash);this.isAppOpen(l,{_localStorage:n})?await this.scheduleCleanup([l],{_localStorage:n,_getBundleFromDb:a,_deleteStaleFileChunksFromDb:o}):await o(l,p);let b=(await a(l))?.meta?.lastOpenedAsSingleNappAt||0;await s(t,{hasUpdate:!1,lastOpenedAsSingleNappAt:b})}static async*updateApps(t,{_updateApp:r=this.updateApp,_addressObjToAppId:o=T,...s}={}){let a=t.length;for(let e=0;e<a;e++){let c=t[e],n=c.tags.find(l=>l[0]==="d")?.[1],i=o({kind:c.kind,pubkey:c.pubkey,dTag:n}),u=r(c,{_addressObjToAppId:o,...s});try{for await(let l of u){let d=Math.floor((e*100+l.appProgress)/a);yield{appId:i,...l,overallProgress:d}}}catch(l){yield{appId:i,appProgress:0,fileProgress:0,error:l,overallProgress:Math.floor(e*100/a)}}}}};w("f-to-signals",function(){let f=this.props.from$??O(this.props.from),t=k(()=>(Array.isArray(f.get())?f.get().flat():Object.keys(f.get())).sort().join(":"));return this.h`${this.h({key:t.get()})`<f-to-signals-wrapped key=${t.get()} props=${{...this.props,from$:f}} />`}`});w("f-to-signals-wrapped",function(){let{render:f,...t}=this.props;return f.call(this,E(t))});var Y=(()=>{let f=new WeakMap,t=0;function r(s){return f.has(s)||f.set(s,`obj:${++t}`),f.get(s)}function o(s){if(s===null)return"null";switch(typeof s){case"undefined":return"undefined";case"string":return`string:${s}`;case"number":return`number:${Number.isNaN(s)?"NaN":s}`;case"boolean":return`boolean:${s}`;case"bigint":return`bigint:${s}n`;case"symbol":return`symbol:${s.description??""}`;case"function":return r(s);case"object":return r(s);default:return`unknown:${String(s)}`}}return function(...a){try{let e=JSON.stringify(a);if(e!==void 0)return e}catch{}return a.map(o).join("|")}})();function L(f,t=250,{getKey:r=Y}={}){let o=new Map,s=new Map,a=new Map,e=Symbol("debounceDefaultKey");return function(...n){let i=r?r(...n):e;if(i==null)throw new Error("debounce: key cannot be undefined or null");let u=s.get(i);if(u)return u;let l=Date.now(),d=o.get(i);if(d!==void 0&&l-d<t)return a.get(i)??(()=>{throw new Error("debounce: no last promise found")})();o.set(i,l);let h=Promise.resolve().then(()=>f.apply(this,n)).catch(p=>{throw o.delete(i),p}).finally(()=>{s.delete(i)});return s.set(i,h),a.set(i,h),h}}async function G(f){await(await q.create(f)).getIcon()}var Q=L(G,1e3);w("appIcon",function(){let f=P(localStorage),t=k(()=>this.props.app$().id),r=k(()=>this.props.app$().index??"?"),o=k(()=>this.props.style$?.()??this.props.style??""),s=A(null),a=k(()=>!!s()),e=A(null);C(async({track:n})=>{let[,i]=n(()=>[t(),f[`session_appById_${t()}_icon$`]()]);if(!(i?.fx&&e()===i.fx)){if(e(i?.fx||null),i?.url){s(i.url);return}s(null)}});let c=A(!1);return C(async({track:n})=>{let i=n(()=>t());if(!(!i||a())){c(!0);try{await Q(i)}catch(u){console.error("Failed to load app icon for appId:",i,u)}finally{requestIdleCallback(()=>c(!1),{timeout:150})}}}),c()?this.h`<div
      style=${`
        width: 100%;
        height: 100%;
        border-style: solid;
        border-width: 0;
        overflow: hidden;
        background-color: ${I.colors.bg2};
      `}
    >
      <style>${`
        @keyframes pulse {
          50% {
            opacity: .5;
          }
        }
        .animate-background {
          animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite;
          background-color: ${I.colors.bg3};
          position: relative;
          height: 100%;
        }
      `}</style>
      <div class='animate-background' />
    </div>`:a()?this.h`
      <img
        src=${s()}
        alt="App Icon"
        style=${`
          width: 100%;
          height: 100%;
          object-fit: cover;
          ${o()}
        `}
      />
    `:this.h`
      <span style=${`
        font-weight: bold;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        ${o()}
      `}>${r()}</span>
    `});function j(){return Math.random().toString(36).slice(2)}var V=async function(f){try{return await se(ee(f),{headers:oe()})}catch(t){return console.log("Could not get avatar image",t.stack),te()}},ee=function(f=j()){return`https://api.dicebear.com/9.x/avataaars/svg?${new URLSearchParams({radius:50,randomizeIds:"true",seed:f}).toString()}`},te=()=>{let f='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 280" fill="none" shape-rendering="auto"><metadata xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/"><rdf:RDF><rdf:Description><dc:title>Avataaars</dc:title><dc:creator>Pablo Stanley</dc:creator><dc:source xsi:type="dcterms:URI">https://avataaars.com/</dc:source><dcterms:license xsi:type="dcterms:URI">https://avataaars.com/</dcterms:license><dc:rights>Remix of \u201EAvataaars\u201D (https://avataaars.com/) by \u201EPablo Stanley\u201D, licensed under \u201EFree for personal and commercial use\u201D (https://avataaars.com/)</dc:rights></rdf:Description></rdf:RDF></metadata><mask id="an70z9ld"><rect width="280" height="280" rx="140" ry="140" x="0" y="0" fill="#fff"/></mask><g mask="url(#an70z9ld)"><g transform="translate(8)"><path d="M132 36a56 56 0 0 0-56 56v6.17A12 12 0 0 0 66 110v14a12 12 0 0 0 10.3 11.88 56.04 56.04 0 0 0 31.7 44.73v18.4h-4a72 72 0 0 0-72 72v9h200v-9a72 72 0 0 0-72-72h-4v-18.39a56.04 56.04 0 0 0 31.7-44.73A12 12 0 0 0 198 124v-14a12 12 0 0 0-10-11.83V92a56 56 0 0 0-56-56Z" fill="#d08b5b"/><path d="M108 180.61v8a55.79 55.79 0 0 0 24 5.39c8.59 0 16.73-1.93 24-5.39v-8a55.79 55.79 0 0 1-24 5.39 55.79 55.79 0 0 1-24-5.39Z" fill="#000" fill-opacity=".1"/><g transform="translate(0 170)"><path d="M132.5 65.83c27.34 0 49.5-13.2 49.5-29.48 0-1.37-.16-2.7-.46-4.02A72.03 72.03 0 0 1 232 101.05V110H32v-8.95A72.03 72.03 0 0 1 83.53 32a18 18 0 0 0-.53 4.35c0 16.28 22.16 29.48 49.5 29.48Z" fill="#ffffff"/></g><g transform="translate(78 134)"><path d="M40 16c0 5.37 6.16 9 14 9s14-3.63 14-9c0-1.1-.95-2-2-2-1.3 0-1.87.9-2 2-1.24 2.94-4.32 4.72-10 5-5.68-.28-8.76-2.06-10-5-.13-1.1-.7-2-2-2-1.05 0-2 .9-2 2Z" fill="#000" fill-opacity=".6"/></g><g transform="translate(104 122)"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 8c0 4.42 5.37 8 12 8s12-3.58 12-8" fill="#000" fill-opacity=".16"/></g><g transform="translate(76 90)"><path d="M27 16c-4.84 0-9 2.65-10.84 6.45-.54 1.1.39 1.85 1.28 1.12a15.13 15.13 0 0 1 9.8-3.22 6 6 0 1 0 10.7 2.8 2 2 0 0 0-.12-.74l-.15-.38a6 6 0 0 0-1.64-2.48C33.9 17.32 30.5 16 27 16ZM85 16c-4.84 0-9 2.65-10.84 6.45-.54 1.1.39 1.85 1.28 1.12a15.13 15.13 0 0 1 9.8-3.22 6 6 0 1 0 10.7 2.8 2 2 0 0 0-.12-.74l-.15-.38a6 6 0 0 0-1.64-2.48C91.9 17.32 88.5 16 85 16Z" fill="#000" fill-opacity=".6"/></g><g transform="translate(76 82)"><path d="M38.03 5.6c-1.48 8.38-14.1 14.17-23.24 10.42a2.04 2.04 0 0 0-2.64 1c-.43.97.04 2.1 1.05 2.5 11.45 4.7 26.84-2.37 28.76-13.3a1.92 1.92 0 0 0-1.64-2.2 2 2 0 0 0-2.3 1.57ZM73.97 5.6c1.48 8.38 14.1 14.17 23.24 10.42 1.02-.41 2.2.03 2.63 1 .43.97-.04 2.1-1.05 2.5-11.44 4.7-26.84-2.37-28.76-13.3a1.92 1.92 0 0 1 1.64-2.2 2 2 0 0 1 2.3 1.57Z" fill="#000" fill-opacity=".6"/></g><g transform="translate(-1)"><path fill-rule="evenodd" clip-rule="evenodd" d="M76 98c.35 1.49 1.67 1.22 2 0-.46-1.55 3.3-28.75 13-36 3.62-2.52 23-4.77 42.31-4.75 19.1 0 38.11 2.26 41.69 4.75 9.7 7.25 13.46 34.45 13 36 .33 1.22 1.65 1.49 2 0 .72-10.3 0-63.73-57-63-57 .73-57.72 52.7-57 63Z" fill="#2c1b18"/></g><g transform="translate(49 72)"/><g transform="translate(62 42)"/></g></g></svg>',t=f.match(/mask id="([^"]*)"/);return f.replaceAll(t,j())},se=async(f,t,r=5e3)=>{let o=new AbortController,s=fetch(f,t),a=new Promise(n=>setTimeout(n,r)),e=await Promise.race([s,a]);if(!e)throw o.abort(),new Error("API took too long to respond");let c=await e.text();if(!e.ok)throw new Error(c);return c},oe=()=>{let f=new Headers;return f.append("Accept","image/svg+xml"),f};w("iconUserCircle",function(){let f=S({path$:["M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0","M12 10m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0","M6.168 18.849a4 4 0 0 1 3.832 -2.849h4a4 4 0 0 1 3.834 2.855"],viewBox$:"2 2 20 20"});return this.h`<a-svg
    props=${{...f,...this.props}}
  />`});w("aAvatar",function(){let f=P(localStorage),{props:t}=this,r=S({usePlaceholder$:t.usePlaceholder$??t.usePlaceholder??!1,pk$:t.pk$??t.pk,picture$(){let o=t.picture$?.()??t.picture??f[`session_accountByUserPk_${this.pk$()}_profile$`]()?.picture;if(!o)return null;let s=/^data:image\/[a-z0-9.+-]+(?:;[a-z0-9=.+-]+)*(?:;base64)?,/i.test(o),a=/^(https?:\/\/)[^\s?#]+\.(png|jpe?g|gif|webp|avif|bmp|ico|svg)(?:[?#].*)?$/i.test(o),e=/^(?:\.{0,2}\/)?[^\s?#]+\.(png|jpe?g|gif|webp|avif|bmp|ico|svg)(?:[?#].*)?$/i.test(o);return s||a||!e?o:null},svg$:H(()=>{let o=r.pk$();if(o)return V(N(o))})});return r.picture$()?this.h`<img
      src=${r.picture$()}
      alt='User avatar'
      style=${`
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        background-color: ${I.colors.bgAvatar};
      `}
    />`:!r.pk$()||!r.svg$()?r.usePlaceholder$()?this.h`<div
          style=${`
            width: 100%;
            height: 100%;
            border-style: solid;
            border-width: 0;
            overflow: hidden;
          `}
        >
          <style>${`
              @keyframes pulse {
                50% {
                  opacity: .5;
                }
              }
            .animate-background {
              animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite;
              background-color: ${I.colors.bgAvatarLoading};
              position: relative;
              height: 100%;
            }
          `}</style>
          <div class='animate-background' />
        </div>`:this.h`<icon-user-circle props=${this.props} />`:this.h`<a-svg props=${{...this.props,svg:r.svg$()}} />`});export{B as a};
